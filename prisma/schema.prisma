// Prisma schema for rental service

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BookingStatus {
  HOLD
  PENDING_PAYMENT
  PAID
  CANCELLED
  MANUAL
}

enum ExtraPriceType {
  PER_BOOKING
  PER_NIGHT
  PER_UNIT
}

enum PaymentProvider {
  TBANK
}

model House {
  id                 String   @id @default(uuid()) @db.Uuid
  title              String
  slug               String   @unique
  description        String
  images             Json
  basePricePerNight  Int
  maxGuests          Int
  active             Boolean  @default(true)
  bookings           Booking[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Extra {
  id         String         @id @default(uuid()) @db.Uuid
  title      String
  slug       String         @unique
  price      Int
  priceType  ExtraPriceType
  active     Boolean        @default(true)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
}

model Booking {
  id         String        @id @default(uuid()) @db.Uuid
  houseId    String        @db.Uuid
  house      House         @relation(fields: [houseId], references: [id])
  startDate  DateTime      @db.Date
  endDate    DateTime      @db.Date
  status     BookingStatus
  holdUntil  DateTime?     @db.Timestamptz(6)
  guestName  String
  phone      String
  email      String?
  comment    String?
  extras     Json?
  nights     Int
  totalPrice Int
  payment    Payment?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([houseId, startDate, endDate])
  @@index([status])
}

model Payment {
  id              String          @id @default(uuid()) @db.Uuid
  bookingId       String          @unique @db.Uuid
  booking         Booking         @relation(fields: [bookingId], references: [id])
  provider        PaymentProvider @default(TBANK)
  amount          Int
  status          String
  tbankPaymentId  String?         @unique
  paymentUrl      String?
  rawInit         Json?
  rawWebhook      Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}
